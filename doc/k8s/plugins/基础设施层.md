# 基础设施

### CNI

`k8s` 本身没有实现自己的容器网络，借助 `CNI` 标准，通过插件的方式集成各种网络插件，实现集群内部网络互通
只关心容器的网络连接，并在容器被删除时移除所分配的资源

##### 容器运行时

容器运行时通过调用网络插件来完成容器的网络设置

- `Container Runtime`
- `CNI`
    - `Loopback plugin`
    - `Bridge plugin`
    - `PTP plugin`
    - `MACvlan`
    - `IPvlan`
    - `3rd-Party`

> 所有 `Pod` 能不通过 `NAT` 互相访问
> 容器内看到的 `IP` 地址和容器外一致

`k8s` 集群中，`IP` 地址是以 `Pod` 为单位进行分配的，每个 `Pod` 有一个独立的地址，内部所有容器共享一个网络栈即宿主机上的一个命名空间
> `Pod` 内部的容器可以通过 `localhost` 相互连接

##### 运行机制

容器运行时在启动时会从 `CNI` 的配置目录中读取 `JSON`
配置文件，存在多个会以名字排序第一个作为默认网络配置，加载获取其中指定的 `CNI` 插件名称和配置参数

容器网络管理，容器运行时一般需要配置两个参数，配置在 `Kubelet`

- `cni-bin-dir`
    - 网络插件的可执行文件
        - 默认 `/opt/cni/bin`
        - 必须实现一个可执行文件，这个文件可以被容器管理系统调用
            - `rkt` 或者 `k8s`
- `cni-conf-dir`
    - 网络插件配置文件
        - 默认 `/etc/cni/net.d`

`CNI` 插件负责将网络接口插入容器网络命名空间（`veth` 对的一端），并在主机上进行改变（`veth` 的另一端连接到网桥）
将 `IP` 分配给接口，通过调用适当的 `IPAM` 插件来设置与 `IP` 地址管理部分一致的路由

##### 社区中插件

- `Flannel`
- `Calico`
- `Weave Net`
- `Cillium`
    - 比较多

### CSI

容器存储接口

##### 组件

- `CSI Driver`
    - 存储供应商提供
        - `Controller Service`
        - `Node Service`
- `CSI Controller`
    - 运行在控制面，处理与存储卷相关的操作
- `CSI Node`
    - 运行在每个 `k8s` 节点，处理卷的挂载和卸载
- `External Provisioner`
    - 控制器，根据 `PVC` 动态创建存储卷
- `External Attacher`
    - 控制器，管理卷的附加和分离操作
- `External Resizer`
    - 控制器，调整卷的大小
- `External Snapshotter`
    - 控制器，管理卷的快照

##### 安装插件

- 安装 `CSI Driver`
    - 使用存储商提供的部署清单，在 `k8s` 集群中安装 `CSI Driver`
- 创建 `StorageClass`
    - 定义 `StorageClass` 资源，指定使用的 `CSI Driver`
- 创建 `PVC`
    - 创建 `PVC`，指定需要的 `StorageClass`
- 使用 `PVC`
    - `Pod` 中使用，`k8s` 会自动处理卷的创建，附加和挂载

##### 运行

- `kubectl`
    - `gRPC Client`
- `CRI shim`
    - `gRPC Server`
- `Container Runtime`
    - `Containers`

### Extended Resources

`k8s` 不支持 `GPU`，需要自定义资源给 `Pod`
`Extended Resources` 允许企业根据需要自定义资源类型，自定义的资源使用和 `CPU` 类似

### Device Plugin

将特定的硬件设备注册到 `kubelet`

##### 设备插件注册

```text
service Registration {
    rpc Register(RegisterRequest) returns (Empty) {}
}
```

- 注册发送信息
    - 发送设备插件的 `UNIX` 套接字
    - 发送设备插件的 `API` 版本
    - 公布 `ResourceName`
- 成功注册，设备插件向 `kubelet` 发送管理的设备列表

##### Virtual Kubelet

`Pod` 资源不仅可以以容器的形式在节点上创建，可以根据需要在期望的位置以期望的形式部署
允许 `k8s` 集群与外部资源进行集成（云服务，边缘计算设备）

