# Leader Election

一种分布式系统中的算法，用于多节点或者进程中通过选举或者投票的形式选出一个节点作为领导者或者主节点
如果选举失败，其余节点会自动重选，确保系统连续容错性
领导者负责协调其他节点的活动，确保系统的一致性和高可用

### 问题

在一个节点组中达成对所有节点对 `Leader` 的共识，基本实现是利用锁来确定领导权
每个实例都尝试获取一个共享锁，锁服务确保只有一个实例在任何给定的时间持有该锁，其他副本尝试获取锁，防止当前节点不可用

##### 领导节点异常

领导节点异常，但是不释放锁，情况比较常见

- 无法处理请求，导致请求超时
- 副本内处理任务的进程被销毁无法启动以处理任务

##### 网络分区问题

锁服务必须是多例运行的，实现服务的高可用，同时必须解决网络分区的问题，负责可能导致不同网络分区中的两个副本都认为自己获取了锁
使用 `Etcd` 解决网络分区问题，确保只有一个分区包含大部分节点才会认可操作合法

> 网络分区，分布式系统中，由于网络故障或延迟，导致系统中的某个节点无法和其他节点通信，进而导致部分系统无法交换信息

### `k8s` 实现

##### 领导节点异常

为锁添加过期时间

##### 网络分区

通过 `k8s Lease` 来实现集运 `Etcd` 的领导者选举，而无需和 `Etcd API` 进行交互
`Lease` 是一个锁资源

- `Lease` 资源实现功能
    - 领导选举
        - 节点尝试获取租约，成功获取的节点称为领导者
        - 状态管理
            - 那个节点是当前的领导者，以及领导者的健康状态
        - 过期机制
            - 租约具有过期时间
    - 分布式锁
        - 多个示例需要访问共享资源，可以作为分布式锁
    - 资源管理
        - 某个资源在特定时间段被某个实例占用
- 场景
    - 控制器管理
        - 防止资源争抢
    - 分布式任务调度
        - 确保只有一个工作负载在执行特定任务
    - 高可用服务
        - 领导者选举

### 使用

##### 自有组件

有些组件需要确保同一时间段一个资源只能被一个组件处理

- `kube-scheduler`
    - 负责 `Pod` 调度，调度过程中需要读取当前 `Node` 资源的状态和当前集群中 `Pod` 状态，选择好 `Node` 之后需要将 `Node`
      名字写入 `Pod`
- `kube-controller-mananger`
    - 同时包含多个 `controller`，需要保证同一个资源同时只有一个控制器操作

##### 抢锁

```bash
kube-controller-manager \
  --leader-elect=true \
  --lease-duration=40s \
  --renew-deadline=30s \
  --retry-period=10s \
  --resource-lock=configmaps \
  --namespace=kube-system \
  --kubeconfig=/etc/kubernetes/controller-manager.conf
  
kubectl -n kube-system get lease
kubectl -n kube-system get lease kube-controller-manager -oyaml
```