`calico` 主流的 `CNI` 实现，解决办法基本和 `calico` 一致，在宿主机上添加路由规则

`<目的容器IP地址段> via <网关的IP地址> dev eth0`
两者的区别在于维护路由的实现，`flannel` 通过 `etcd`，`Calico` 使用了 `BGP` 来自动的分发路由信息

### BGP

边界网关协议，运行在不同自治系之间交换路由信息的外部网关协议
一种在大规模网络中实现的节点路由共享协议

> 边界网关运行（路由器），取代主机路由表功能，彼此通信维护路由表信息

集群中是所有节点，被当作边界路由来处理，互相之间通过 `BGP` 协议交换路由规则

##### 组成

- `Calico CNI` 插件
    - 和 `k8s` 对接部分
- `Felix`
    - `DaemonSet`，负责宿主机插入路由规则
- `BIRD`
    - `BGP` 客户端，负责集群里分发路由规则信息

##### 模式

- `Node-to-Node Mesh`
  - 每个节点都需要和其他节点相连接，无法用于大规模集群
- `Route Reflector`
  - 指定几个节点专门建立 `BGP` 连接，其他节点去学习

##### 执行流程

[流程图](./calico.puml)

因为没有使用到网桥模式，`Calico CNI` 插件会为每个容器设置一个 `Veth Pair` 设备，放在宿主机的一端以 `cali` 开头
因为没有使用网桥，需要设置路由规则，使得 `Veth Pair` 设备接收 `IP` 包

```bash
10.233.2.3 dev cali5863f3 scope link
```

容器发出的 `IP` 包会经过 `Veth Pair` 设备出现在宿主机，根据路由规则的下一跳 `IP`，将其转发给正确的网关

`Felix` 负责维护下一跳的路由规则，路由信息是通过 `BIRD` 组件获取


### IPIP

隧道的一种，类似 `Flannel VXLAN`

[流程图](./calico_ipip.puml)

