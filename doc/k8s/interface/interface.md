# 开放接口

`k8s` 通过标准化的开放接口，实现了资源的解耦和扩展
使得 `kubelet` 能够在无需重新编译的情况下支持多种容器运行时

### 核心开放接口

- `CRI`
  - 容器运行时接口
    - 计算资源管理
- `CNI`
  - 容器网络接口
    - 网络资源管理
- `CSI`
    - 容器存储接口
      - 存储资源管理

##### CRI

不是通用的容器运行时 `API`，专门为 `kubelet` 和运行时通讯以及节点级故障排查工具设计的

主要定义了两个 `gRPC` 服务
- `RuntimeService`
  - 管理 `Pod` 沙盒和容器完整生命周期
- `ImageService`
  - 独立处理所有镜像相关操作，允许运行时分别使用不同的后端存储镜像和运行容器

###### 使用场景

- `kubelet`
  - 管理 `Pod` 和容器
  - 资源使用统计
  - 运行时容器执行命令
  - 流式获取容器日志
  - 端口转发和调试
- 节点级故障排查
  - 封装 `crictl`命令行工具

###### 主流实现

- `containerd`
- `CRI-O`
  - 专门兼容 `k8s`，主要使用于 `OpenShift`
- 安全增强型运行时
  - 不能直接实现 `CRI` 接口，但是可以通过适配器集成
    - `kata`
    - `gVisor`

##### CNI

只关注网络设置、连接和资源清理，便于实现和各种容器运行时集成

###### 网络配置

`CNI` 使用 `JSON` 格式的网络配置，由 `CNI` 运行时处理，并传递给各插件

```json
{
  "cniVersion": "1.1.0",
  "name": "example-network",
  "plugins": [
    {
      "type": "bridge",
      "bridge": "cni0",
      "ipam": {
        "type": "host-local",
        "subnet": "10.22.0.0/16"
      }
    }
  ]
}
```

###### 插件分类

- 接口插件
  - 在容器内创建和配置网络接口
    - `bridge`
    - `macvlan`
- 链式插件
  - 对已有接口进行修改或扩展功能
    - `portmap`
    - `bandwidth`
- `IPAM` 插件
  - 负责 `IP` 地址的分配和管理
- `Meta` 插件
  - 顺序调用多个插件
    - `flannel`
    - `multus`

###### libcni 库

供容器运行时和 `CNI` 插件交互

- 加载和解析网络配置
- 按需设置环境变量并执行插件
- 处理和缓存插件结果
