# 路由构建

路由构建是最为核心的逻辑，安装顺序 资源组 -> 资源版本 -> 资源

- `kube-apiserver` 在启动时，会读取所有的 `RESTStorage`，`RESTStorage` 以资源组为单位，保存资源组下所有的版本和资源处理函数
- `New` 方法，读取所有的 `RESTStorage`，并调用 `InstallAPIs` 方法安装路由
- 以资源组为单位，为所有资源组安装路由
    - 变量传入的所有 `APIGroupInfo`，读取资源组版本列表，安装具体的某一个资源版的路由

### `HTTP` 请求路径格式

`/{api,apis}/{apiVersion}/{resourceType}/{resourceName}`

- `apiVersion`
    - 指定 `API` 的版本
        - 核心 `API`
            - 格式为 `{version}` 以 `/api` 路径作为前缀，组名为 ` `
        - 扩展 `API`
            - 格式为 `{group}/{version}` 以及 `/apis` 路径作为前缀
- `resourceType`
    - 指定要操作的类型
    - `pods`
    - `services`
    - `deployments`
- `resourceName` 可选
    - 指定特定资源名称
- `namespace` 可选
    - 用于指定资源所在的命名空间，仅特定类型请求中需要
- 案例
    - `/api/{apiVersion}/namespaces/{namespace}/{resourceType}`
        - 命名空间内的资源
    - `/api/{apiVersion}/namespaces/{namespace}/{resourceType}/{resourceName}`
        - 特定命名空间内的特定资源
    - `/api/{apiVersion}/{resourceType}`
        - 对于 `Cluster` 级别，不受命名空间限制


### 请求方法构建

`pkg/controlplane/instance.go` 文件中的 `New` 方法

- 导包，执行 `init()` 函数，将资源的资源组、资源版本、资源等信息注册到资源注册表
- 调用函数创建 `GenericAPIServer` 类型的实例，并初始化 `Handler` 字段
- `routes.Logs{}.Install(s.Handler.GoRestfulContainer)` 安装 `HTTP` 路由
  - 调用 `go-restful` 包提供的路由注册函数，完成路由注册
- 创建 `restStorageProviders` 变量，保存内置的 `RESTStorageProvider`
  - `RESTStorageProvider` 资源提供者，负责和底层存储之间读写
- `m.InstallAPIs`
  - 安装资源的 `REST` 路由
  - 遍历 `apiGroupInfos`
    - 先检查版本是否为空，为空没有需要安装的版本，跳过


##### GenericAPIServer 

- `LoopbackClientConfig *restclient.Config`
  - 内部的 `webhook` 和 `controller` 会通过这个连接 `kube-apiserver`，并访问其中资源
- `minRequestTimeout time.Duration`
  - 最小超时时间
- `ShutdownTimeout time.Duration`
  - 关停超时时间，服务器再指定时间内关停
- `legacyAPIGroupPrefixes sets.String`
  - 设置授权和验证请求的 `URL` 解析前缀
- `admissionControl admission.Interface`
  - 构建 `API` 组的 `REST` 存储，控制请求是否被允许
- `SecureServingInfo *SecureServingInfo`
  - 保存 `TLS` 配置信息
- `ExternalAddress string`
  - 设置对外的 `APIServer` 地址
- `Serializer runtime.NegotiatedSerializer`
  - 控制 `API` 对象序列化，支持不同的组/版本
- `Handler *APIServerHandler`
  - 进行 `HTTP` 路由设置
- `UnprotectedDebugSocket *routes.DebugSocket`
  - 提供调试信息的 `Unix` 域套接字，不进行身份验证
- `openAPIConfig *openapicommon.Config`
  - 启用 `Swagger` 或者 `OpenAPI`

##### APIServerHandler

- `GoRestfulContainer *restful.Container`
  - 此字段用来安装 `API` 接口
  - 使用 `go-restful` 框架来安装路由
- `NonGoRestfulMux *mux.PathRecorderMux`
  - 请求链的最后请求，包含非 `go-restful` 路由
  - 根据 `HTTP` 中的 `Path` 做精确和前缀匹配查找，连接对应的 `Handler`
- `Director http.Handler`
  - 最终处理 `HTTP` 请求的 `Handler`，可以直接调用，也可以放在最后

通过上述定义可以知道 `kube-apiserver` 中包含以下 4 类路由
- `FullHandlerChain`
  - 等层 `HTTP` 处理链，对外监听并接收请求
- `GoRestfulContainer` 最核心的路由
  - 承载所有 `go-restful` 框架注册的 `API` 资源
- `NonGoRestfulMux`
  - 用于注册不走 `go-restful` 的路由
    - `/healthz`
    - 自定义探针，监控和调试端点
- `Director`
  - 将实际请求分发到 `GoRestfulContainer` 或 `NonGoRestfulMux` 分流的 `handler`

### 处理链

`NewConfig` 函数中 `BuildHandlerChainFunc` 是用来设置 `HTTP` 处理链函数，默认使用 `DefaultBuildHandlerChain`
- 默认处理链
  - 授权中间件
    - 检查访问权限
  - `Trace` 中间件
    - 记录请求完成时间，以便分析延迟
  - 限制流
    - 开启中间件管理请求中间件
    - 不开启，使用限制并发中间件
  - 添加身份代理中间件
  - 添加审计中间件
    - 记录 `HTTP` 请求
  - 认证中间件
  - 跨域中间件
  - 超时处理
  - 等