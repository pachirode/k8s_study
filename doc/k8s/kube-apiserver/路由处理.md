# 路由处理

一个请求到达 `kube-apiserver` 实例之后，路由表会匹配请求方法和请求路径，并根据请求结果找到对应的路由函数，处理请求
路由函数统一存放在 `registry` 目录下

- `apps`
    - 资源组下所有版本和请求处理逻辑
    - `daemonset`
        - `daemonset` 所有版本的路由函数
        - `storage`
            - 存储层的具体实现，定义资源对象交互的存储逻辑
                - 对象的增删改查
        - `strategy.go`
            - 包含资源对象策略
                - 创建，更新，删除时的验证和逻辑转换
    - `deployment`
        - `deployment` 资源所有版本的路由函数
    - `rest`
        - `storage_apps.go`
            - 包含创建 `apps` 资源组 `RESTStorage` 的结构体和方法
    - `batch`
        - 和上面类似结构

### 主要处理逻辑

- 对象处理策略
    - 处理请求之前，需要执行部分操作
    - 对象创建前
    - 资源更新前
- 请求处理策略
    - 将处理之后的资源保存到后端存储中
    - `Create`
    - `Get`
    - `Upodate`
    - `Destroy`
    - `ConvertToTable`
        - 将资源对象转换为表格形式，以便后续展示

### 处理 HTTP 请求的流程

[流程](http请求流程.puml)

- 路由匹配
- 添加 `HTTP` 处理链
- `Mutating Admission Controller` `Validating Admission Controller`
    - 将版本化的资源转化为内部版本资源
- 执行创建前的处理策略
    - 主要需要关心的是验证逻辑
- 进入到方法中

##### 请求到达路由函数

`createHandler` 执行逻辑

- 初始化调用链 `Span` 节点
- 参数解析
    - 从请求中获取资源的命名空间和名词
    - 解析请求中的参数，将参数解析到 `CreateOptions` 类型中
    - 校验解析的参数值
    - 创建一个空资源 `original`
    - 将请求体参数解析到变量中
    - 记录请求审计
- 执行 `mutationg webhook`
- 执行请求，`rest.NamedCreater Create` 完成具体请求处理逻辑

##### 资源请求

实际底层是调用 `genericregistry.Store` 类型自带的一些 `ETCD` 操作相关的方法
