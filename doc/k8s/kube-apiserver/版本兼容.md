# API 兼容机制

版本兼容要求
- 添加可选功能
  - 使用可选字段
- 不改变现有语义
  - 默认值的行为和语义
  - 不改变现有类型字段
  - 不该变值的可选性
  - 有效值无效值不能互换
- 调用
  - 版本变更前可以正常请求，变更之后也要可以
  - 转换为不同的版本，不能丢失信息
  - 支持回滚

### 向前兼容 向后兼容

- 向后兼容
  - 新版本的 `API` 能够支持旧版本的客户端
  - 使用旧版本的客户端请求，可以正常解析和使用，而忽视新增的字段
- 向前兼容
  - 及版本的客户端可以处理新版本的 `API`
  - 使用新版的 `API` 尽可能的正常工作，即使无法使用新版的功能
    - 忽略新增字段
    - 数据格式更新也不会导致崩溃

### 添加不稳定功能

在现有 `API` 版本中添加新字段，必须确保默认情况下禁用该功能
引入 `feature gate`，管理新字段及其相关功能的启用状态
- 添加 `omitempty` 结构体标签
- 添加 `// +optional` 注释标签
- 当字段为空时，该字段在 `API` 响应中完全不存在（可选字段为指针）

# 版本

### 类别

- `Development`
  - 对象版本，无约定
  - 无可用性，代码未被提交主分支
- `Alpha`
  - 新特性默认禁止，可以通过 `Feature Gate` 开启
  - 一些操作或者命令行可能未被支持
  - 集群不一定可靠
  - 后续可能会被删除
- `Beta`
  - 新特性默认禁止
  - 所有组件包含完整的功能
  - 提供升级文档，可以手动或者自动升级对象
  - 集群可靠性获得一定保障
  - 新特性后续会被支持
- `Stable`

### 版本转换

版本号
- 外部版本
  - 对外暴露的版本号，有明确的版本标识
  - 实际开发中，可以根据需要指定版本号
- 内部版本
  - 内部使用的版本号，不直接对外暴露
  - 默认未最新的外部版本号定义的参数
- 存储版本
  - `Etcd` 中使用的版本号

##### 转换方式

外部版本号不会直接互转，通常是先转成内部版本，再转换成期望的外部版本

- 通过 `kubectl create` 创建资源对象，客户端使用的是 `External Version`，对外暴露的 `version scheme`
  - 转换为 `Interval version`
  - 转换为 `storage version`
- 通过 `kubectl get` 查询资源对象，根据客户端使用的版本
  - 将 `Storage Version` 转换成 `Internal version`
  - 再转换为 `External version`

